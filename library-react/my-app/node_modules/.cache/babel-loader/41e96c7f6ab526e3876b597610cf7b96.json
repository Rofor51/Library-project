{"ast":null,"code":"/* eslint-disable complexity */\nvar http = require('./http');\n\nvar util = require('./util');\n\nvar Q = require('q');\n\nvar AuthSdkError = require('./errors/AuthSdkError');\n\nvar AuthPollStopError = require('./errors/AuthPollStopError');\n\nvar config = require('./config');\n\nfunction addStateToken(res, options) {\n  var builtArgs = util.clone(options) || {}; // Add the stateToken if one isn't passed and we have one\n\n  if (!builtArgs.stateToken && res.stateToken) {\n    builtArgs.stateToken = res.stateToken;\n  }\n\n  return builtArgs;\n}\n\nfunction getStateToken(res) {\n  return addStateToken(res);\n}\n\nfunction transactionStatus(sdk, args) {\n  args = addStateToken(sdk, args);\n  return http.post(sdk, sdk.options.url + '/api/v1/authn', args);\n}\n\nfunction resumeTransaction(sdk, args) {\n  if (!args || !args.stateToken) {\n    var stateToken = sdk.tx.exists._getCookie(config.STATE_TOKEN_COOKIE_NAME);\n\n    if (stateToken) {\n      args = {\n        stateToken: stateToken\n      };\n    } else {\n      return Q.reject(new AuthSdkError('No transaction to resume'));\n    }\n  }\n\n  return sdk.tx.status(args).then(function (res) {\n    return new AuthTransaction(sdk, res);\n  });\n}\n\nfunction transactionExists(sdk) {\n  // We have a cookie state token\n  return !!sdk.tx.exists._getCookie(config.STATE_TOKEN_COOKIE_NAME);\n}\n\nfunction postToTransaction(sdk, url, options) {\n  return http.post(sdk, url, options).then(function (res) {\n    return new AuthTransaction(sdk, res);\n  });\n}\n\nfunction getPollFn(sdk, res, ref) {\n  return function (options) {\n    var delay;\n    var rememberDevice;\n\n    if (util.isNumber(options)) {\n      delay = options;\n    } else if (util.isObject(options)) {\n      delay = options.delay;\n      rememberDevice = options.rememberDevice;\n    }\n\n    if (!delay && delay !== 0) {\n      delay = config.DEFAULT_POLLING_DELAY;\n    } // Get the poll function\n\n\n    var pollLink = util.getLink(res, 'next', 'poll');\n\n    function pollFn() {\n      var href = pollLink.href;\n\n      if (rememberDevice) {\n        href += '?rememberDevice=true';\n      }\n\n      return http.post(sdk, href, getStateToken(res), {\n        saveAuthnState: false\n      });\n    }\n\n    ref.isPolling = true;\n    var retryCount = 0;\n\n    var recursivePoll = function () {\n      // If the poll was manually stopped during the delay\n      if (!ref.isPolling) {\n        return Q.reject(new AuthPollStopError());\n      }\n\n      return pollFn().then(function (pollRes) {\n        // Reset our retry counter on success\n        retryCount = 0; // If we're still waiting\n\n        if (pollRes.factorResult && pollRes.factorResult === 'WAITING') {\n          // If the poll was manually stopped while the pollFn was called\n          if (!ref.isPolling) {\n            throw new AuthPollStopError();\n          } // Continue poll\n\n\n          return Q.delay(delay).then(recursivePoll);\n        } else {\n          // Any non-waiting result, even if polling was stopped\n          // during a request, will return\n          ref.isPolling = false;\n          return new AuthTransaction(sdk, pollRes);\n        }\n      }).fail(function (err) {\n        // Exponential backoff, up to 16 seconds\n        if (err.xhr && (err.xhr.status === 0 || err.xhr.status === 429) && retryCount <= 4) {\n          var delayLength = Math.pow(2, retryCount) * 1000;\n          retryCount++;\n          return Q.delay(delayLength).then(recursivePoll);\n        }\n\n        throw err;\n      });\n    };\n\n    return recursivePoll().fail(function (err) {\n      ref.isPolling = false;\n      throw err;\n    });\n  };\n}\n\nfunction link2fn(sdk, res, obj, link, ref) {\n  if (Array.isArray(link)) {\n    return function (name, opts) {\n      if (!name) {\n        throw new AuthSdkError('Must provide a link name');\n      }\n\n      var lk = util.find(link, {\n        name: name\n      });\n\n      if (!lk) {\n        throw new AuthSdkError('No link found for that name');\n      }\n\n      return link2fn(sdk, res, obj, lk, ref)(opts);\n    };\n  } else if (link.hints && link.hints.allow && link.hints.allow.length === 1) {\n    var method = link.hints.allow[0];\n\n    switch (method) {\n      case 'GET':\n        return function () {\n          return http.get(sdk, link.href);\n        };\n\n      case 'POST':\n        return function (opts) {\n          if (ref && ref.isPolling) {\n            ref.isPolling = false;\n          }\n\n          var data = addStateToken(res, opts);\n\n          if (res.status === 'MFA_ENROLL') {\n            // Add factorType and provider\n            util.extend(data, {\n              factorType: obj.factorType,\n              provider: obj.provider\n            });\n          }\n\n          var href = link.href;\n\n          if (data.rememberDevice !== undefined) {\n            if (data.rememberDevice) {\n              href += '?rememberDevice=true';\n            }\n\n            data = util.omit(data, 'rememberDevice');\n          } else if (data.profile && data.profile.updatePhone !== undefined) {\n            if (data.profile.updatePhone) {\n              href += '?updatePhone=true';\n            }\n\n            data.profile = util.omit(data.profile, 'updatePhone');\n          }\n\n          return postToTransaction(sdk, href, data);\n        };\n    }\n  }\n}\n\nfunction links2fns(sdk, res, obj, ref) {\n  var fns = {};\n\n  for (var linkName in obj._links) {\n    if (!obj._links.hasOwnProperty(linkName)) {\n      continue;\n    }\n\n    var link = obj._links[linkName];\n\n    if (linkName === 'next') {\n      linkName = link.name;\n    }\n\n    if (link.type) {\n      fns[linkName] = link;\n      continue;\n    }\n\n    switch (linkName) {\n      // poll is only found at the transaction\n      // level, so we don't need to pass the link\n      case 'poll':\n        fns.poll = getPollFn(sdk, res, ref);\n        break;\n\n      default:\n        var fn = link2fn(sdk, res, obj, link, ref);\n\n        if (fn) {\n          fns[linkName] = fn;\n        }\n\n    }\n  }\n\n  return fns;\n}\n\nfunction flattenEmbedded(sdk, res, obj, ref) {\n  obj = obj || res;\n  obj = util.clone(obj);\n\n  if (Array.isArray(obj)) {\n    var objArr = [];\n\n    for (var o = 0, ol = obj.length; o < ol; o++) {\n      objArr.push(flattenEmbedded(sdk, res, obj[o], ref));\n    }\n\n    return objArr;\n  }\n\n  var embedded = obj._embedded || {};\n\n  for (var key in embedded) {\n    if (!embedded.hasOwnProperty(key)) {\n      continue;\n    } // Flatten any nested _embedded objects\n\n\n    if (util.isObject(embedded[key]) || Array.isArray(embedded[key])) {\n      embedded[key] = flattenEmbedded(sdk, res, embedded[key], ref);\n    }\n  } // Convert any links on the embedded object\n\n\n  var fns = links2fns(sdk, res, obj, ref);\n  util.extend(embedded, fns);\n  obj = util.omit(obj, '_embedded', '_links');\n  util.extend(obj, embedded);\n  return obj;\n}\n\nfunction AuthTransaction(sdk, res) {\n  if (res) {\n    this.data = res;\n    util.extend(this, flattenEmbedded(sdk, res, res, {}));\n    delete this.stateToken; // RECOVERY_CHALLENGE has some responses without _links.\n    // Without _links, we emulate cancel to make it intuitive\n    // to return to the starting state. We may remove this\n    // when OKTA-75434 is resolved\n\n    if (res.status === 'RECOVERY_CHALLENGE' && !res._links) {\n      this.cancel = function () {\n        return new Q(new AuthTransaction(sdk));\n      };\n    }\n  }\n}\n\nmodule.exports = {\n  transactionStatus: transactionStatus,\n  resumeTransaction: resumeTransaction,\n  transactionExists: transactionExists,\n  postToTransaction: postToTransaction\n};","map":{"version":3,"sources":["C:/Users/robin/Desktop/sso/my-app/node_modules/@okta/okta-signin-widget/node_modules/@okta/okta-auth-js/lib/tx.js"],"names":["http","require","util","Q","AuthSdkError","AuthPollStopError","config","addStateToken","res","options","builtArgs","clone","stateToken","getStateToken","transactionStatus","sdk","args","post","url","resumeTransaction","tx","exists","_getCookie","STATE_TOKEN_COOKIE_NAME","reject","status","then","AuthTransaction","transactionExists","postToTransaction","getPollFn","ref","delay","rememberDevice","isNumber","isObject","DEFAULT_POLLING_DELAY","pollLink","getLink","pollFn","href","saveAuthnState","isPolling","retryCount","recursivePoll","pollRes","factorResult","fail","err","xhr","delayLength","Math","pow","link2fn","obj","link","Array","isArray","name","opts","lk","find","hints","allow","length","method","get","data","extend","factorType","provider","undefined","omit","profile","updatePhone","links2fns","fns","linkName","_links","hasOwnProperty","type","poll","fn","flattenEmbedded","objArr","o","ol","push","embedded","_embedded","key","cancel","module","exports"],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\nvar http              = require('./http');\nvar util              = require('./util');\nvar Q                 = require('q');\nvar AuthSdkError      = require('./errors/AuthSdkError');\nvar AuthPollStopError = require('./errors/AuthPollStopError');\nvar config            = require('./config');\n\nfunction addStateToken(res, options) {\n  var builtArgs = util.clone(options) || {};\n\n  // Add the stateToken if one isn't passed and we have one\n  if (!builtArgs.stateToken && res.stateToken) {\n    builtArgs.stateToken = res.stateToken;\n  }\n\n  return builtArgs;\n}\n\nfunction getStateToken(res) {\n  return addStateToken(res);\n}\n\nfunction transactionStatus(sdk, args) {\n  args = addStateToken(sdk, args);\n  return http.post(sdk, sdk.options.url + '/api/v1/authn', args);\n}\n\nfunction resumeTransaction(sdk, args) {\n  if (!args || !args.stateToken) {\n    var stateToken = sdk.tx.exists._getCookie(config.STATE_TOKEN_COOKIE_NAME);\n    if (stateToken) {\n      args = {\n        stateToken: stateToken\n      };\n    } else {\n      return Q.reject(new AuthSdkError('No transaction to resume'));\n    }\n  }\n  return sdk.tx.status(args)\n    .then(function(res) {\n      return new AuthTransaction(sdk, res);\n    });\n}\n\nfunction transactionExists(sdk) {\n  // We have a cookie state token\n  return !!sdk.tx.exists._getCookie(config.STATE_TOKEN_COOKIE_NAME);\n}\n\nfunction postToTransaction(sdk, url, options) {\n  return http.post(sdk, url, options)\n    .then(function(res) {\n      return new AuthTransaction(sdk, res);\n    });\n}\n\nfunction getPollFn(sdk, res, ref) {\n  return function (options) {\n    var delay;\n    var rememberDevice;\n\n    if (util.isNumber(options)) {\n      delay = options;\n    } else if (util.isObject(options)) {\n      delay = options.delay;\n      rememberDevice = options.rememberDevice;\n    }\n\n    if (!delay && delay !== 0) {\n      delay = config.DEFAULT_POLLING_DELAY;\n    }\n\n    // Get the poll function\n    var pollLink = util.getLink(res, 'next', 'poll');\n    function pollFn() {\n      var href = pollLink.href;\n      if (rememberDevice) {\n        href += '?rememberDevice=true';\n      }\n      return http.post(sdk, href, getStateToken(res), {\n        saveAuthnState: false  \n      });\n    }\n\n    ref.isPolling = true;\n\n    var retryCount = 0;\n    var recursivePoll = function () {\n\n      // If the poll was manually stopped during the delay\n      if (!ref.isPolling) {\n        return Q.reject(new AuthPollStopError());\n      }\n\n      return pollFn()\n        .then(function (pollRes) {\n          // Reset our retry counter on success\n          retryCount = 0;\n\n          // If we're still waiting\n          if (pollRes.factorResult && pollRes.factorResult === 'WAITING') {\n\n            // If the poll was manually stopped while the pollFn was called\n            if (!ref.isPolling) {\n              throw new AuthPollStopError();\n            }\n\n            // Continue poll\n            return Q.delay(delay)\n              .then(recursivePoll);\n\n          } else {\n            // Any non-waiting result, even if polling was stopped\n            // during a request, will return\n            ref.isPolling = false;\n            return new AuthTransaction(sdk, pollRes);\n          }\n        })\n        .fail(function(err) {\n          // Exponential backoff, up to 16 seconds\n          if (err.xhr &&\n              (err.xhr.status === 0 || err.xhr.status === 429) &&\n              retryCount <= 4) {\n            var delayLength = Math.pow(2, retryCount) * 1000;\n            retryCount++;\n            return Q.delay(delayLength)\n              .then(recursivePoll);\n          }\n          throw err;\n        });\n    };\n    return recursivePoll()\n      .fail(function(err) {\n        ref.isPolling = false;\n        throw err;\n      });\n  };\n}\n\nfunction link2fn(sdk, res, obj, link, ref) {\n  if (Array.isArray(link)) {\n    return function(name, opts) {\n      if (!name) {\n        throw new AuthSdkError('Must provide a link name');\n      }\n\n      var lk = util.find(link, {name: name});\n      if (!lk) {\n        throw new AuthSdkError('No link found for that name');\n      }\n\n      return link2fn(sdk, res, obj, lk, ref)(opts);\n    };\n\n  } else if (link.hints &&\n      link.hints.allow &&\n      link.hints.allow.length === 1) {\n    var method = link.hints.allow[0];\n    switch (method) {\n\n      case 'GET':\n        return function() {\n          return http.get(sdk, link.href);\n        };\n\n      case 'POST':\n        return function(opts) {\n          if (ref && ref.isPolling) {\n            ref.isPolling = false;\n          }\n\n          var data = addStateToken(res, opts);\n\n          if (res.status === 'MFA_ENROLL') {\n            // Add factorType and provider\n            util.extend(data, {\n              factorType: obj.factorType,\n              provider: obj.provider\n            });\n          }\n\n          var href = link.href;\n          if (data.rememberDevice !== undefined) {\n            if (data.rememberDevice) {\n              href += '?rememberDevice=true';\n            }\n            data = util.omit(data, 'rememberDevice');\n\n          } else if (data.profile &&\n                    data.profile.updatePhone !== undefined) {\n            if (data.profile.updatePhone) {\n              href += '?updatePhone=true';\n            }\n            data.profile = util.omit(data.profile, 'updatePhone');\n          }\n\n          return postToTransaction(sdk, href, data);\n        };\n    }\n  }\n}\n\nfunction links2fns(sdk, res, obj, ref) {\n  var fns = {};\n  for (var linkName in obj._links) {\n    if (!obj._links.hasOwnProperty(linkName)) {\n      continue;\n    }\n\n    var link = obj._links[linkName];\n    \n    if (linkName === 'next') {\n      linkName = link.name;\n    }\n\n    if (link.type) {\n      fns[linkName] = link;\n      continue;\n    }\n\n    switch (linkName) {\n      // poll is only found at the transaction\n      // level, so we don't need to pass the link\n      case 'poll':\n        fns.poll = getPollFn(sdk, res, ref);\n        break;\n\n      default:\n        var fn = link2fn(sdk, res, obj, link, ref);\n        if (fn) {\n          fns[linkName] = fn;\n        }\n    }\n  }\n  return fns;\n}\n\nfunction flattenEmbedded(sdk, res, obj, ref) {\n  obj = obj || res;\n  obj = util.clone(obj);\n\n  if (Array.isArray(obj)) {\n    var objArr = [];\n    for (var o = 0, ol = obj.length; o < ol; o++) {\n      objArr.push(flattenEmbedded(sdk, res, obj[o], ref));\n    }\n    return objArr;\n  }\n\n  var embedded = obj._embedded || {};\n\n  for (var key in embedded) {\n    if (!embedded.hasOwnProperty(key)) {\n      continue;\n    }\n\n    // Flatten any nested _embedded objects\n    if (util.isObject(embedded[key]) || Array.isArray(embedded[key])) {\n      embedded[key] = flattenEmbedded(sdk, res, embedded[key], ref);\n    }\n  }\n\n  // Convert any links on the embedded object\n  var fns = links2fns(sdk, res, obj, ref);\n  util.extend(embedded, fns);\n\n  obj = util.omit(obj, '_embedded', '_links');\n  util.extend(obj, embedded);\n  return obj;\n}\n\nfunction AuthTransaction(sdk, res) {\n  if (res) {\n    this.data = res;\n    util.extend(this, flattenEmbedded(sdk, res, res, {}));\n    delete this.stateToken;\n\n    // RECOVERY_CHALLENGE has some responses without _links.\n    // Without _links, we emulate cancel to make it intuitive\n    // to return to the starting state. We may remove this\n    // when OKTA-75434 is resolved\n    if (res.status === 'RECOVERY_CHALLENGE' && !res._links) {\n      this.cancel = function() {\n        return new Q(new AuthTransaction(sdk));\n      };\n    }\n  }\n}\n\nmodule.exports = {\n  transactionStatus: transactionStatus,\n  resumeTransaction: resumeTransaction,\n  transactionExists: transactionExists,\n  postToTransaction: postToTransaction\n};\n"]},"metadata":{},"sourceType":"script"}